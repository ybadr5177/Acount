@model CustomerBasketViewModel
@{
    ViewData["Title"] = "Index";
    Layout = "_LayoutTheOtherPage";
}
@inject IViewLocalizer localizer
@{
    var isRTL = CultureInfo.CurrentCulture.Name.StartsWith("ar");
}

<style>

    .CartDesktop_container__Fl7mQ {
        display: flex;
        flex-direction: row-reverse;
        justify-content: space-between;
        gap: 30px;
        margin: 20px auto;
        padding: 20px 45px;
        max-width: 1440px;
        min-width: 768px;
        min-height: 260px;
        box-sizing: border-box;
        font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        color: #404553;
    }
    /* Scroll داخلي لقائمة المنتجات */
    .products-container {
        max-height: 500px; /* الطول اللي تحبه */
        overflow-y: auto; /* يعمل Scroll داخلي */
        flex: 2; /* ياخد مساحة أكبر */
        padding: 10px;
        border: 1px solid #ddd;
        border-radius: 10px;
    }
    /* العمود الأول: المنتجات */
    .CartDesktop_columnOne__QFO4H {
        flex: 2;
        display: flex;
        flex-direction: column;
        gap: 20px;
    }

    /* المنتج كـ مستطيل */
    .CartItemDesktop_mainWrapper__10l20 {
        display: flex;
        flex-direction: row; /* الصورة يمين والمحتوى شمال */
        align-items: flex-start;
        background: #fff;
        border: 1px solid #e5e5e5;
        border-radius: 8px;
        padding: 15px;
        gap: 20px;
        transition: box-shadow 0.3s ease-in-out;
        width: 100%;
        min-height: auto;
    }

        .CartItemDesktop_mainWrapper__10l20:hover {
            box-shadow: 0 4px 12px rgba(0,0,0,0.08);
        }

    /* صورة المنتج */
    .CartItemDesktop_imageCtr__EJxU_ {
        flex: 0 0 140px; /* عرض ثابت */
        display: flex;
        align-items: center;
        justify-content: center;
    }

        .CartItemDesktop_imageCtr__EJxU_ img {
            max-width: 120px;
            max-height: 140px;
            object-fit: contain;
            border-radius: 6px;
        }

    /* محتوى المنتج */
    .CartItemDesktop_contentCtr__Bti9o {
        flex: 1;
        display: flex;
        flex-direction: column;
        justify-content: space-between;
        gap: 10px;
    }

    .CartItemDesktop_title__mQPWc {
        font-size: 16px;
        font-weight: 600;
        margin: 0;
        line-height: 1.4;
    }

    .CartItemDesktop_shippingDetailsWrapper__CO8p8 {
        font-size: 14px;
        color: #666;
    }

    .CartItemDesktop_soldByCtr__Asifz {
        font-size: 14px;
        margin-top: 5px;
    }

    /* السعر والكمية */
    .CartItemDesktop_priceWrapper__coPP0 {
        font-size: 16px;
        font-weight: bold;
        color: #000;
        margin-top: 10px;
    }

    .CartItemDesktop_discountCtr__ipmDn {
        font-size: 14px;
        color: #f00;
    }

    /* العمود الثاني: ملخص الطلب */
    .CartDesktop_columnTwo__WkPxt {
        flex: 1;
        background: #fff;
        border-radius: 8px;
        padding: 20px;
        height: fit-content;
        box-shadow: 0 4px 12px rgba(0,0,0,0.08);
        position: sticky;
        top: 20px;
    }

    .CartInvoiceSummary_innerHeader__7p_yE {
        font-size: 18px;
        font-weight: 600;
        margin-bottom: 15px;
    }

    /* زر الدفع */
    .CartInvoiceColumn_checkoutContainer__IUjG_ button {
        width: 100%;
        background: #000;
        color: #fff;
        padding: 12px 0;
        font-size: 16px;
        font-weight: 600;
        border: none;
        border-radius: 6px;
        cursor: pointer;
        margin-top: 20px;
        transition: background 0.3s;
    }

        .CartInvoiceColumn_checkoutContainer__IUjG_ button:hover {
            background: #333;
        }


    .CartInvoiceSummary_discountInputWrapper__BL5Wi {
        display: flex;
        flex-direction: column;
        gap: 10px;
        margin-bottom: 15px;
    }

    .DiscountInput_innerWrapper__UAJip {
        display: flex;
        gap: 8px;
    }

    .DiscountInput_textInput__oBuQv {
        flex: 1;
        padding: 10px;
        border: 1px solid #ddd;
        border-radius: 6px;
        font-size: 14px;
    }

    .DiscountInput_submitButton__p_szU {
        background: #0b5394;
        color: #fff;
        border: none;
        border-radius: 6px;
        padding: 10px 16px;
        cursor: pointer;
        font-weight: 600;
        transition: background 0.3s;
    }

        .DiscountInput_submitButton__p_szU:hover {
            background: #0b5394;
        }

    /* زر مشاهدة العروض */
    .CouponCenterDetails_viewAvailableOffers__ujx6_ {
        display: flex;
        align-items: center;
        gap: 6px;
        color: #0070f3;
        font-size: 14px;
        font-weight: 600;
        background: none;
        border: none;
        cursor: pointer;
    }

    /* الصفوف */
    .CartInvoiceSummary_row__8YWEk {
        display: flex;
        justify-content: space-between;
        padding: 8px 0;
        font-size: 14px;
    }

    .CartInvoiceSummary_withBorder__iMeD0 {
        border-top: 1px solid #ddd;
        margin-top: 10px;
        padding-top: 10px;
    }

    .CartInvoiceSummary_highlightText__APQve {
        color: #70f300;
        font-weight: bold;
    }

    .CartInvoiceSummary_largerText___ASw8 {
        font-size: 16px;
        font-weight: 600;
    }

    /* رسالة الخصم */
    .CartInvoiceSummary_couponMessage__SOAd0 {
        display: flex;
        align-items: center;
        gap: 8px;
        color: #70f300;
        font-size: 14px;
        font-weight: 500;
    }

    /* الأقساط */
    .Emi_container__0EdQG {
        display: flex;
        align-items: center;
        gap: 8px;
        font-size: 14px;
        margin: 15px 0;
        color: #404553;
    }

    /* زر الدفع */
    .Button_primary__K3lZi {
        width: 100%;
        background: #3f779e;
        color: #fff;
        padding: 12px 0;
        font-size: 16px;
        font-weight: 600;
        border: none;
        border-radius: 6px;
        cursor: pointer;
        transition: background 0.3s;
    }

        .Button_primary__K3lZi:hover {
            background: #3f779e;
        }

    /* مكان الكمية + الحذف */
    .CartItemDesktop_actions__C4tRk {
        display: flex;
        flex-direction: row-reverse; /* عكس اتجاه المحتوى */
        gap: 10px;
        margin-top: 10px;
    }

    /* دروب داون الكمية */
    .CartItemDesktop_quantitySelect__LKf23 {
        padding: 6px 10px;
        border: 1px solid #ddd;
        border-radius: 6px;
        font-size: 14px;
        cursor: pointer;
        background: #fff;
    }

    /* زر الحذف */
    .CartItemDesktop_removeBtn__Qp9Ak {
        background: #f44336;
        color: #fff;
        border: none;
        border-radius: 6px;
        padding: 6px 14px;
        font-size: 14px;
        font-weight: 600;
        cursor: pointer;
        transition: background 0.3s;
    }

        .CartItemDesktop_removeBtn__Qp9Ak:hover {
            background: #d32f2f;
        }
</style>
<div class="CartDesktop_container__Fl7mQ" dir="rtl">


    <!-- العمود الأول: قائمة المنتجات -->
    <div class="CartDesktop_column__4I16X CartDesktop_columnOne__QFO4H products-container">


        @foreach (var basket in Model.Items)
        {
            <!-- تقدر تكرر المنتجات هنا ... -->
            <div class="CartItemDesktop_mainWrapper__10l20">

                <!-- صورة المنتج -->
                <div class="CartItemDesktop_imageCtr__EJxU_">
                    <img src="@basket.PictureUrl"
                         alt="@basket.ProductName">
                </div>

                <!-- محتوى المنتج -->
                <div class="CartItemDesktop_contentCtr__Bti9o">

                    <h1 class="CartItemDesktop_title__mQPWc">
                        @basket.ProductDescription
                    </h1>

                    @* <div class="CartItemDesktop_shippingDetailsWrapper__CO8p8">
                        <b>التوصيل:</b> الأربعاء، 3 سبتمبر
                    </div> *@

                    <div class="CartItemDesktop_soldByCtr__Asifz">
                        @localizer["Soldby"]: <strong>@basket.Categories</strong>
                    </div>

                    <div class="CartItemDesktop_priceWrapper__coPP0">
                        @basket.Price
                    </div>

                    <div class="CartItemDesktop_discountCtr__ipmDn">
                        <span> @basket.BaseDiscountPrice</span>
                    </div>
                </div>
                <div class="CartItemDesktop_actions__C4tRk">
                   
                    <div class="CartItemDesktop_shippingDetailsWrapper__CO8p8">
                        <b>@localizer["Quantity"]:</b> @basket.Quantity
                    </div>

                    <button class="CartItemDesktop_removeBtn__Qp9Ak remove-btn"
                            data-id="@basket.Id"
                            data-size="@basket.Size">
                        @localizer["delete"]
                    </button>
                </div>
            </div>
        }

    </div>
   
    <div class="CartDesktop_column__4I16X CartDesktop_columnTwo__WkPxt">
        <!-- BasketId -->
        <input type="hidden" name="BasketId" value="@Model.Id" />
       @*  <div class="CartDesktop_column__4I16X CartDesktop_columnTwo__WkPxt">

            
        </div> *@
        <h2 class="CartInvoiceSummary_innerHeader__7p_yE">@localizer["Ordersummary"]</h2>

        <!-- إدخال الكوبون -->
        <div class="CartInvoiceSummary_discountInputWrapper__BL5Wi">
            <div class="DiscountInput_outerWrapper__XdFgD">
                <div class="DiscountInput_innerWrapper__UAJip">
                    <input class="DiscountInput_textInput__oBuQv"
                           placeholder="@localizer["Enterthecode"]"
                           aria-label="@localizer["Enterthecode"]"
                           type="text">
                    <button class="DiscountInput_submitButton__p_szU">@localizer["Apply"]</button>
                </div>
            </div>
           @*  <button class="CouponCenterDetails_viewAvailableOffers__ujx6_">
                <img src="https://f.nooncdn.com/s/app/com/noon/icons/coupon-discount-blue.svg" alt="offers" width="20">
                <span>مشاهدة العروض المتاحة</span>
                <img src="https://f.nooncdn.com/s/app/com/noon/icons/chevron-left-blue.svg" alt="more" width="20">
            </button> *@
        </div>

        <!-- المجموع الفرعي -->
        <div class="CartInvoiceSummary_row__8YWEk">
            <div class="CartInvoiceSummary_column__qYLBi">
                <span class="CartInvoiceSummary_label__bAXSx"> @localizer["Subtotal"]</span>
                <span class="CartInvoiceSummary_label__bAXSx">(@Model?.Items.Count)</span>
            </div>
            <div class="CartInvoiceSummary_column__qYLBi" id="subtotal">0 $ @* @(Model.p* Model.Quantity) *@</div>
        </div>

        <!-- كوبون -->
        <div class="CartInvoiceSummary_row__8YWEk">
            <div class="CartInvoiceSummary_column__qYLBi">@localizer["coupon"]</div>
            <div class="CartInvoiceSummary_column__qYLBi CartInvoiceSummary_highlightText__APQve" id="discount">00.00 $</div>
        </div>

      @*   <!-- رسوم الشحن -->
        <div class="CartInvoiceSummary_row__8YWEk">
            <div class="CartInvoiceSummary_column__qYLBi">
                <span class="CartInvoiceSummary_label__bAXSx">رسوم الشحن</span>
            </div>
            <div class="CartInvoiceSummary_column__qYLBi CartInvoiceSummary_highlightText__APQve" id="shipping">مجاناً</div>
        </div> *@

        <!-- رسالة الخصم -->
        <div class="CartInvoiceSummary_row__8YWEk">
            <div class="CartInvoiceSummary_couponMessage__SOAd0">
               @*  <img src="https://f.nooncdn.com/s/app/com/noon/icons/cart.svg" alt="خصم" width="20">
                <span>مبروك عليك الخصم!</span> *@
            </div>
        </div>

        <!-- المجموع النهائي -->
        <div class="CartInvoiceSummary_row__8YWEk CartInvoiceSummary_withBorder__iMeD0">
            <div class="CartInvoiceSummary_column__qYLBi CartInvoiceSummary_largerText___ASw8">
                <h2 class="CartInvoiceSummary_total__n6NmT">@localizer["total"]</h2>
              @*   <span class="CartInvoiceSummary_label__bAXSx">(شامل ضريبة القيمة المضافة)</span> *@
            </div>
            <div class="CartInvoiceSummary_column__qYLBi CartInvoiceSummary_largerText___ASw8" id="total">00 $</div>
        </div>

        <!-- تفاصيل الأقساط -->
        @* <div class="CartInvoiceColumn_messageContainer__21G_Q">
            <div class="Emi_container__0EdQG">
                <img src="https://f.nooncdn.com/s/app/com/noon/icons/emi.svg" alt="emi" width="20">
                <span>خطط الدفع الشهرية تبدأ من <strong>500 $</strong></span>
            </div>
        </div> *@

        <!-- زر الدفع -->


        <form asp-action="payview" asp-controller="Basket" method="get" id="checkoutForm" class="CartInvoiceColumn_checkoutContainer__IUjG_">
            <button type="submit" class="Button_primary__K3lZi">@localizer["Paymentpage"]</button>
           </form>




    </div>
</div>

    <script>
                const cartDiv = document.querySelector("body > div.CartDesktop_container__Fl7mQ");
        if (cartDiv) {
            console.log("تم العثور على العنصر:", cartDiv);
        } else {
            console.log("العنصر غير موجود");
        }
    </script>
    <!-- script remove item-->
    <script>
              document.addEventListener("DOMContentLoaded", () => {
            document.querySelectorAll(".remove-btn").forEach(btn => {
                btn.addEventListener("click", function () {
                    const productId = this.dataset.id;
                    const size = this.dataset.size;

                    fetch('/Basket/RemoveItem', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'RequestVerificationToken': document.querySelector('input[name="__RequestVerificationToken"]')?.value || ""
                        },
                        body: JSON.stringify({ productId: productId, size: size })
                    })
                    .then(res => {
                        if (res.ok) {
                            this.closest(".CartItemDesktop_mainWrapper__10l20").remove();
                        } else {
                            alert("حصل خطأ أثناء الحذف");
                        }
                    });
                });
            });
        });
    </script>

@* <script>
   document.addEventListener("DOMContentLoaded", () => {

    const subtotalElement = document.querySelector("#subtotal");
    const discountElement = document.querySelector("#discount");
    const totalElement = document.querySelector("#total");
    const couponInput = document.querySelector(".DiscountInput_textInput__oBuQv");
    const applyBtn = document.querySelector(".DiscountInput_submitButton__p_szU");
    const checkoutBtn = document.querySelector(".Button_primary__K3lZi");
    const shippingCost = 0; // أو اجلبها ديناميكي

    // حساب المجموع الفرعي
    function calculateSubtotal() {
        let subtotal = 0;
        document.querySelectorAll(".CartItemDesktop_mainWrapper__10l20").forEach(item => {
            const price = parseFloat(item.querySelector(".CartItemDesktop_priceWrapper__coPP0").textContent) || 0;
               const quantityDiv = item.querySelector(".CartItemDesktop_shippingDetailsWrapper__CO8p8");
              const quantity = quantityDiv ? parseInt(quantityDiv.textContent.replace(/\D/g, '')) || 1 : 1;
            subtotal += price * quantity;
        });
        subtotalElement.textContent = subtotal.toFixed(2) + " $";
        return subtotal;
    }

    // تحديث المجموع النهائي
    function updateTotal(discount = 0) {
        const subtotal = calculateSubtotal();
        const total = subtotal + shippingCost - discount;
        totalElement.textContent = total.toFixed(2) + " $";
        discountElement.textContent = `- ${discount.toFixed(2)} $`;
    }

    // تطبيق الكوبون
    if(applyBtn) {
        applyBtn.addEventListener("click", async () => {
            const code = couponInput.value.trim().toUpperCase();
              if(!code) {
         alert("لم يتم إدخال كود،ارجو ادخال كود ");
         updateTotal(0); // خصم = صفر
         return;
     }

            try {
                  const response = await fetch('/Mastar/FindTheDiscountCode', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'RequestVerificationToken': document.querySelector('input[name="__RequestVerificationToken"]')?.value || ""
                    },
                     body: JSON.stringify(code)
                });

                const data = await response.json();
                let discount = 0;

                if(data.isValid){
                    discount = data.amount;
                    alert(`تم تطبيق الكوبون! تم خصم ${discount.toFixed(2)} $`);
                } else {
                    alert("الكود غير صالح");
                }

                updateTotal(discount);

            } catch (err) {
                console.error(err);
                alert("حدث خطأ أثناء التحقق من الكوبون");
            }
        });
    }

    // إزالة منتج
    document.querySelectorAll(".remove-btn").forEach(btn => {
        btn.addEventListener("click", function () {
            const productId = this.dataset.id;
            const size = this.dataset.size;

            fetch('/Mastar/RemoveItem', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'RequestVerificationToken': document.querySelector('input[name="__RequestVerificationToken"]')?.value || ""
                },
                body: JSON.stringify({ productId: productId, size: size })
            })
            .then(res => {
                if(res.ok){
                    this.closest(".CartItemDesktop_mainWrapper__10l20").remove();
                    updateTotal(); // تحديث المجموع بعد الحذف
                } else {
                    alert("حصل خطأ أثناء الحذف");
                }
            });
        });
    });

    // تحديث الحساب عند تحميل الصفحة
    updateTotal(0);

    });
</script> *@
    <script>
        document.addEventListener("DOMContentLoaded", () => {

            const subtotalElement = document.querySelector("#subtotal");
            const discountElement = document.querySelector("#discount");
            const totalElement = document.querySelector("#total");
            const couponInput = document.querySelector(".DiscountInput_textInput__oBuQv");
            const applyBtn = document.querySelector(".DiscountInput_submitButton__p_szU");
            const checkoutBtn = document.querySelector(".Button_primary__K3lZi");
            const shippingCost = 0; // أو اجلبها ديناميكي

            let appliedDiscountId = ""; // نخزن هنا ID الخصم
            let appliedDiscountAmount = 0; // نخزن هنا قيمة الخصم

            // حساب المجموع الفرعي
            function calculateSubtotal() {
                let subtotal = 0;
                document.querySelectorAll(".CartItemDesktop_mainWrapper__10l20").forEach(item => {
                    const price = parseFloat(item.querySelector(".CartItemDesktop_priceWrapper__coPP0").textContent) || 0;
                    const quantityDiv = item.querySelector(".CartItemDesktop_shippingDetailsWrapper__CO8p8");
                    const quantity = quantityDiv ? parseInt(quantityDiv.textContent.replace(/\D/g, '')) || 1 : 1;
                    subtotal += price * quantity;
                });
                subtotalElement.textContent = subtotal.toFixed(2) + " $";
                return subtotal;
            }

            // تحديث المجموع النهائي
            function updateTotal(discount = 0) {
                const subtotal = calculateSubtotal();
                const total = subtotal + shippingCost - discount;
                totalElement.textContent = total.toFixed(2) + " $";
                discountElement.textContent = ` ${discount.toFixed(2)} $`;
            }

            // تطبيق الكوبون
            if(applyBtn) {
                applyBtn.addEventListener("click", async () => {
                    const code = couponInput.value.trim().toUpperCase();
                    if(!code) {
                        alert("لم يتم إدخال كود،ارجو ادخال كود ");
                        appliedDiscountId = "";
                        appliedDiscountAmount = 0;
                        updateTotal(0); // خصم = صفر
                        return;
                    }

                    try {
                        const response = await fetch('/Mastar/FindTheDiscountCode', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                                'RequestVerificationToken': document.querySelector('input[name="__RequestVerificationToken"]')?.value || ""
                            },
                            body: JSON.stringify(code)
                        });

                        const data = await response.json();

                        if(data.isValid){
                            appliedDiscountId = data.id; // تخزين ID الخصم
                            appliedDiscountAmount = data.amount || 0; // تخزين قيمة الخصم
                            alert(`تم تطبيق الكوبون! تم خصم ${appliedDiscountAmount.toFixed(2)} $`);
                        } else {
                            alert("الكود غير صالح");
                            appliedDiscountId = "";
                            appliedDiscountAmount = 0;
                        }

                        updateTotal(appliedDiscountAmount);

                    } catch (err) {
                        console.error(err);
                        alert("حدث خطأ أثناء التحقق من الكوبون");
                    }
                });
            }

            // زر الدفع
            if(checkoutBtn) {
                checkoutBtn.addEventListener("click", (e) => {
                    e.preventDefault();
                    const form = checkoutBtn.closest("form");
                    if(appliedDiscountId) {
                        // إضافة input مخفي للفورم يحمل ID الخصم
                        let discountInput = document.querySelector("#DiscountId");
                        if(!discountInput) {
                            discountInput = document.createElement("input");
                            discountInput.type = "hidden";
                            discountInput.name = "DiscountId";
                            discountInput.id = "DiscountId";
                            form.appendChild(discountInput);
                        }
                        discountInput.value = appliedDiscountId;
                    }
                    form.submit();
                });
            }

            // إزالة منتج
            document.querySelectorAll(".remove-btn").forEach(btn => {
                btn.addEventListener("click", function () {
                    const productId = this.dataset.id;
                    const size = this.dataset.size;

                    fetch('/Mastar/RemoveItem', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'RequestVerificationToken': document.querySelector('input[name="__RequestVerificationToken"]')?.value || ""
                        },
                        body: JSON.stringify({ productId: productId, size: size })
                    })
                    .then(res => {
                        if(res.ok){
                            this.closest(".CartItemDesktop_mainWrapper__10l20").remove();
                            updateTotal(appliedDiscountAmount); // تحديث المجموع بعد الحذف
                        } else {
                            alert("حصل خطأ أثناء الحذف");
                        }
                    });
                });
            });

            // تحديث الحساب عند تحميل الصفحة
            updateTotal(appliedDiscountAmount);

        });
    </script>




